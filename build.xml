<project name="yeti" default="compiler" basedir=".">

<target name="prepare-build">
    <property name="asm" value="${basedir}/asm-3.1.jar"/>
    <available property="has.asm" file="${asm}"/>
</target>

<target name="fetch" depends="prepare-build" unless="has.asm">
    <get src="http://linux.ee/~mzz/asm-3.1.jar" dest="${asm}" verbose="true"/>
</target>

<target name="lib" unless="no.lib.build">
    <mkdir dir="${basedir}/.build/lib"/>
    <javac destdir="${basedir}/.build/lib" srcdir="${basedir}/lib" debug="on"
        encoding="UTF-8" source="1.4" target="1.4" debuglevel="source,lines"/>
</target>

<target name="checklib">
    <available property="no.lib.build" file="${basedir}/.build/lib" type="dir"/>
</target>

<target name="compiler" depends="checklib,lib,fetch">
    <mkdir dir="${basedir}/.build/compiler"/>
    <javac destdir="${basedir}/.build/compiler" srcdir="${basedir}/c"
           encoding="UTF-8" source="1.4" target="1.4" debuglevel="source,lines"
           debug="on" classpath="${asm}:${basedir}/.build/lib"/>
</target>

<target name="modules">
    <!-- TODO: write yetic ant task -->
    <fileset id="module.srcs" dir="${basedir}/modules" includes="*.yeti"/>
    <pathconvert pathsep=" " property="module.srclist" refid="module.srcs"/>
    <java classname="yeti.lang.compiler.YetiC" fork="false" failonerror="true"
          classpath="${asm}:${basedir}/.build/lib:${basedir}/.build/compiler">
        <arg value="-Cd"/>
        <arg value="${basedir}/.build/modules"/>
        <arg line="${module.srclist}"/>
    </java>
</target>

<target name="yeti" depends="compiler,modules">
    <jar jarfile="${basedir}/yeti.jar">
        <manifest>
            <attribute name="Main-Class" value="yeti.lang.compiler.YetiC"/>
        </manifest>
        <fileset dir="${basedir}/.build/lib"/>
        <fileset dir="${basedir}/.build/compiler"/>
        <fileset dir="${basedir}/.build/modules"/>
        <zipfileset src="${asm}"/>
    </jar>
</target>

<target name="clean">
    <delete dir="${basedir}/.build"/>
</target>

<target name="rebuild" depends="clean,yeti"/>

</project>
